---
title: "Synthetic South Africa Coding"
author: "Yiwen Sun"
date: "2024-06-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load the Packages
```{r}
library(readr)
library(Synth)
library(dplyr)
library(ggplot2)
```

Import the Second Sample
Treated Unit: South Africa
```{r}
library(readr)
sample2 <- read_csv("/Users/sunyiwen/Desktop/msc_thesis/methodology/data/3_final_processed_data/sample2_southaf.csv")

sample2 <- as.data.frame(sample2)
```

**Prepare the Synthetic Control Data**

1. Excludes units that is not workable with synth()
```{r}
## Exclude those without complete pre-treatment EDI data
# define the pre-treatment period
pre_treatment_period <- 1970:2002

# identify countries with NAs during the pre-treatment period
countries_with_na <- sample2 %>%
  filter(year %in% pre_treatment_period) %>%
  group_by(countrycode) %>%
  summarize(has_na = any(is.na(exportdiv))) %>%
  filter(has_na) %>%
  pull(countrycode)

# exclude these countries from the dataset
sample2<- sample2 %>%
  filter(!countrycode %in% countries_with_na)


## Exclude those without any predictor variables available in the pre-treatment period
# specify the countries that need exclusion (from the dataprep function)
countries_to_exclude <- c(31, 729,887,24,784,180,262,226,566,634,740,762,860,894,192, 4, 116, 414, 68, 52, 834, 418,524, 558, 792)

# finalize the sample data to proceed
sample2 <- sample2 %>%
  filter(!countrycode %in% countries_to_exclude)
```


2. Prepare the synth data
```{r}
sa.data <- dataprep(
  foo = sample2,
  predictors = c("ncc","pscom", "psenroll", "trade", "fdi", 
                                      "gdpg", "popn", "govscore", "latitude"),
  dependent = "exportdiv",
  unit.variable = "countrycode",
  unit.names.variable = "country",
  time.variable = "year",
  treatment.identifier = sample2$countrycode[sample2$country == "South Africa"][1],
  controls.identifier = unique(sample2$countrycode[sample2$country != "South Africa"]),
  time.predictors.prior = c(1970:2002),
  time.optimize.ssr = c(1970:2003),
  time.plot = c(1970:2014)
  )
```

**Outcome Visualization**

1. Getting the synthetic South Africa
```{r}
sa.synth <- synth(sa.data, Margin.ipop = 5.3e-04)
```

2. Plot the synthetic and actual outcome
```{r}
path.plot(synth.res = sa.synth,
          dataprep.res = sa.data,
          tr.intake = 2003,
          Ylab = "Export Diversification Index",
          Xlab = "South Africa",
          Ylim = c(0,5))
text(x=1970, y=4.5, labels = paste("MSPE=0.395"), pos = 4)
```


**Deeper Analysis**

The biggest contributors of the synthetic South Africa
```{r}
sa.weights <- sa.synth$solution.w
## the biggest contributors are 32, 600, 450, 360
### Argentina, Indonesia, Madagascar, Paraguay
```

The biggest contributing covariates
```{r}
sa.vars <- sa.synth$solution.v
# primary school completion rate, gdpg
```


**Estimation and Visualization of the Treatment Effects**

1. Calculation of the treatment effects by year
```{r}
synthetic.outcome <- sa.data$Y0plot %*% sa.weights
actual.outcome <- sample2$exportdiv[sample2$country=="South Africa" & sample2$year>1969]

sa.treatment.effects <- actual.outcome - synthetic.outcome
```

2. Plot the treatment effects by year
```{r}
plot(sa.treatment.effects,
     type = "l",
     lwd = "2",
     ylim = c(-2.5, 2.5),
     xlab = " ",
     ylab = "Change in Export Diversification Index",
     xaxt = "n")
axis(1, at=c(1, 10, 20, 30, 40), labels = c(1970, 1980, 1990, 2000, 2010))
abline(v=33, lty=3)
abline(h=0)
```


**Causal Inference**

```{r}
plot(sa.treatment.effects,
     type = "l",
     lwd = "2",
     ylim = c(-2.5, 2.5),
     xlab = " ",
     ylab = "Change in Export Diversification Index",
     xaxt = "n" )
axis(1, at=c(1, 10, 20, 30, 40), labels = c(1970, 1980, 1990, 2000, 2010))
abline(v=33, lty=3)
abline(h=0)
legend("topleft", c("South Africa", "Placebo"), lty=c(1,2))


## adding the placebos
# create a subset of untreated countries
sample2.controls <- subset(sample2, sample2$country != "South Africa")

# write a for loop to add the placebos one by one
for(i in 1:length(unique(sample2.controls$country))){
  my.country <- unique(sample2.controls$country)[i] # one country each time
  
  controls.data <- dataprep(sample2.controls,
                            predictors = c("ncc",
                                           "pscom", 
                                           "psenroll",
                                           "trade", 
                                           "fdi",
                                           "gdpg", 
                                           "popn", 
                                           "govscore", 
                                           "latitude"),
                            dependent = "exportdiv",
                           unit.variable = "countrycode",
                           unit.names.variable = "country",
                           time.variable = "year",
                           treatment.identifier = my.country,
                           controls.identifier = 
                             c(unique(sample2.controls$country[
                               sample2.controls$country != my.country])),
                           time.predictors.prior = c(1970:2002),
                           time.optimize.ssr = c(1970:2003),
                           time.plot = c(1970:2014)) # prep synth data for control group
  
  synth.control <- synth(controls.data, Margin.ipop = 5.1e-04)
  control.weights <- synth.control$solution.w
  
  placebo.synthetic.outcome <- controls.data$Y0plot %*% control.weights
  placebo.actual.outcome <- sample2$exportdiv[sample2$country == my.country & 
                                                sample2$year > 1969]
  placebo.treatment.effects <- placebo.actual.outcome - placebo.synthetic.outcome # estimate the treatment effects for the placebo units
  
 
    lines(placebo.treatment.effects, lty = 2, lwd = 1, col = "grey") # plot the placebo units

} ## end of the for loop
```





